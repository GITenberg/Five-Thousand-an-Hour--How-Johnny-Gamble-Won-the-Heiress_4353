sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: HCV/skpZnTC9BsksbND/cLyZ9TgDwHtkA++1JybAPzTWRcAwxuok6BHosNodeEQS88WLnKqE1dOFtbcQNPXudiwMS52PYlgOr/WO22DTE7Gde0DV2+gHNZLAnx8BTt4ySH6qm+zejqLeeuIADEPCX9Fx+OF2Wgy+gHsuvhfNoEHl4ZdwVuddEnJDN0f8zLm37oAr8SKbw9tUU+JyCH9P0ml/+PahPIoo7GFrVK7E6Ieq1/jBfPCb5crm1isRgXyTF+QSG0e8F+Pwz79Bd7WFGuSHQfB7pT6ajdynwCAO5UrzKlgnGIutX3DksfIK8KSBdmLIHiAcWNMd2u4QhoihGEh5p/CYeQY1Uqubcz1nkpJBfLdy+0OFKZVTwDcAGL5NOaBroWh0KcU222P804eLan49GJqS7YhYDvbywbWsly8+gZylxO2fMrMYllT/iDvTBGN9cDad8mgPqoA7Gq+OqiM3VGQXQh33Rrktdve/oeFkCYAOyG8l0SY2FjAwUPpdD9adq1a7J4zU7/bke8tkbl/0MCioBMR4QfWEzuGgJL0Zn/1DgCTjuDD3mIygV0+8Xi7IoD9JRZb44T7FWS5WxTzjvmFKWbmuxG/QgwQszGAEK1wx6m/RiEueJFffmRP/UpIHNHCE0QAcQDlSHwl3ev7xqoiRfOV/A82sXIS85To=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Five-Thousand-an-Hour--How-Johnny-Gamble-Won-the-Heiress_4353
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy